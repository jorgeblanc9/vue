name: Deploy Vue App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build and deploy with Docker Compose
      run: |
        # Parar contenedores existentes si estÃ¡n corriendo
        docker-compose -f docker-compose-localhost.yml down || true
        
        # Limpiar imÃ¡genes antiguas para ahorrar espacio
        docker system prune -f
        
        # Construir y levantar los servicios
        docker-compose -f docker-compose-localhost.yml up -d --build
        
        # Esperar a que el servicio estÃ© listo
        echo "Esperando a que el servicio estÃ© listo..."
        timeout=120
        counter=0
        while [ $counter -lt $timeout ]; do
          if curl -f http://localhost:5174/health >/dev/null 2>&1; then
            echo "âœ… Servicio Vue estÃ¡ listo en http://localhost:5174"
            break
          fi
          echo "â³ Esperando servicio... ($counter/$timeout)"
          sleep 2
          counter=$((counter + 2))
        done
        
        if [ $counter -ge $timeout ]; then
          echo "âŒ Timeout esperando el servicio"
          docker-compose -f docker-compose-localhost.yml logs
          exit 1
        fi
        
        # Verificar que el servicio responde correctamente
        echo "ğŸ” Verificando servicio..."
        curl -f http://localhost:5174/ || exit 1
        
        echo "âœ… Deploy completado exitosamente"
        
    - name: Show service status
      run: |
        echo "ğŸ“Š Estado de los contenedores:"
        docker-compose -f docker-compose-localhost.yml ps
        
        echo "ğŸ“‹ Logs del servicio:"
        docker-compose -f docker-compose-localhost.yml logs --tail=20 app
        
        echo "ğŸŒ Servicio disponible en: http://localhost:5174"
