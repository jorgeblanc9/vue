name: Deploy Vue App (Production)

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build production image
      run: |
        # Construir imagen de producci√≥n
        docker build -f Dockerfile-vite -t vue-app:production .
        
        # Verificar que la imagen se construy√≥ correctamente
        docker images vue-app:production
        
    - name: Deploy production container
      run: |
        # Parar contenedor anterior si existe
        docker stop vue-app-production || true
        docker rm vue-app-production || true
        
        # Ejecutar contenedor de producci√≥n
        docker run -d \
          --name vue-app-production \
          --network microservices-network \
          -p 8080:80 \
          --restart unless-stopped \
          vue-app:production
        
        # Esperar a que el servicio est√© listo
        echo "Esperando a que el servicio de producci√≥n est√© listo..."
        timeout=60
        counter=0
        while [ $counter -lt $timeout ]; do
          if curl -f http://localhost:8080/health >/dev/null 2>&1; then
            echo "‚úÖ Servicio de producci√≥n est√° listo en http://localhost:8080"
            break
          fi
          echo "‚è≥ Esperando servicio de producci√≥n... ($counter/$timeout)"
          sleep 2
          counter=$((counter + 2))
        done
        
        if [ $counter -ge $timeout ]; then
          echo "‚ùå Timeout esperando el servicio de producci√≥n"
          docker logs vue-app-production
          exit 1
        fi
        
        # Verificar endpoints
        echo "üîç Verificando endpoints..."
        curl -f http://localhost:8080/ || exit 1
        curl -f http://localhost:8080/health || exit 1
        curl -f http://localhost:8080/build-info || exit 1
        
        echo "‚úÖ Deploy de producci√≥n completado exitosamente"
        
    - name: Show production status
      run: |
        echo "üìä Estado del contenedor de producci√≥n:"
        docker ps | grep vue-app-production
        
        echo "üìã Logs del servicio de producci√≥n:"
        docker logs --tail=20 vue-app-production
        
        echo "üåê Servicio de producci√≥n disponible en: http://localhost:8080"
        echo "üè• Health check: http://localhost:8080/health"
        echo "‚ÑπÔ∏è  Build info: http://localhost:8080/build-info"
